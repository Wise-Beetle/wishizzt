<!DOCTYPE html>
<html lang="en">
<head>

<link rel="icon" type="image/png" href="./favicon(32x32).png">
  

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wishlizzt</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
    color: #333;
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
    display: flex;
  }

  /* Sidebar for lists */
  #sidebar {
    width: 200px;
    background-color: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-right: 20px;
  }

  #sidebar h2 {
    font-size: 18px;
    margin-bottom: 10px;
  }

  #listContainer {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: 0.2s;
  }

  .list-item.active {
    background-color: #FFDD99;
    font-weight: bold;
  }

  .list-item:hover {
    background-color: #ffe6b3;
  }

  .list-menu {
    position: relative;
    cursor: pointer;
    padding: 0 6px;
    font-weight: bold;
  }

  .list-tooltip {
    position: absolute;
    right: 0;
    top: 18px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    z-index: 1000;
    min-width: 120px;
  }

  .list-tooltip button {
    width: 100%;
    background: none;
    border: none;
    padding: 8px 10px;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
  }

  .list-tooltip button:hover {
    background-color: #f4f4f4;
  }

  /* Main content area */
  #mainContent {
    flex: 1;
  }

  h1 {
    text-align: center;
    color: #FF9900;
    margin-bottom: 30px;
  }

  .input-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
  }

  .input-group input, .input-group button, .input-group select {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .input-group button {
    background-color: #FF9900;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: 0.2s;
  }

  .input-group button:hover {
    background-color: #e68a00;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
  }

  th, td {
    text-align: left;
    padding: 12px;
  }

  th {
    background-color: #FF9900;
    color: white;
  }

  tr:nth-child(even) {
    background-color: #f4f4f4;
  }

  tfoot td {
    font-weight: bold;
    background-color: #ffe6b3;
  }

  button.remove-btn {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: 0.2s;
  }

  button.remove-btn:hover {
    background-color: #c0392b;
  }

  .preview-card {
    display: flex;
    align-items: center;
    background-color: #fff;
    padding: 10px;
    margin-top: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    gap: 15px;
  }

  .preview-card img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .preview-card div {
    display: flex;
    flex-direction: column;
  }

  .preview-card a {
    color: #FF9900;
    text-decoration: none;
    font-weight: bold;
  }

  .preview-card a:hover {
    text-decoration: underline;
  }

  @media (max-width: 900px) {
    body {
      flex-direction: column;
      max-width: 600px;
    }

    #sidebar {
      width: 100%;
      margin-bottom: 20px;
    }
  }

  select.qty-dropdown {
    width: 60px;
    padding: 4px;
    font-size: 14px;
  }

  /* CSV floating menu */
  #csvMenu {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 3000;
  }

  #csvMenuBtn {
    background-color: #FF9900;
    color: white;
    border: none;
    border-radius: 28px;
    padding: 12px 18px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  }

  #csvMenuBtn:hover {
    background-color: #e68a00;
  }

  #csvMenuOptions {
    position: absolute;
    bottom: 56px;
    right: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.2);
    overflow: hidden;
    min-width: 180px;
    display: none;
  }

  #csvMenuOptions button {
    width: 100%;
    border: none;
    background: none;
    padding: 12px 16px;
    text-align: left;
    cursor: pointer;
    font-size: 15px;
  }

  #csvMenuOptions button:hover {
    background-color: #f4f4f4;
  }

</style>
</head>
<body>

<div id="sidebar">
  <h2>Lists</h2>
  <div id="listContainer"></div>
  <button id="newListBtn">+ Create New List</button>
</div>

<div id="mainContent">
  <h1>WishLizzt¬Æ</h1>

  <!-- Manual input -->
  <div class="input-group">
    <input type="text" id="productLink" placeholder="Paste link here">
    <input type="text" id="productName" placeholder="Enter product name">
    <input type="number" id="productPrice" placeholder="Enter price (USD)">
    <input type="number" id="productQuantity" placeholder="Quantity" value="1" min="1">
    <button onclick="addProduct()">Add</button>
  </div>

  <!-- Hidden file input for CSV -->
  <input type="file" id="csvFile" accept=".csv" style="display:none">
  <button id="exportBtn" style="display:none"></button>

  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>Link</th>
        <th>Price (USD)</th>
        <th>Quantity</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="wishlistBody"></tbody>
    <tfoot>
      <tr>
        <td colspan="2">Total</td>
        <td id="totalPrice">0.00</td>
        <td id="totalQuantity">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <div id="previews"></div>
</div>

<!-- CSV floating menu -->
<div id="csvMenu">
  <button id="csvMenuBtn" title="Import / Export CSV">
    üìÅ CSV
  </button>
  <div id="csvMenuOptions">
    <button id="csvImportBtn">üì• Import CSV</button>
    <button id="csvExportBtn">üì§ Export CSV</button>
  </div>
</div>

<script>
/* ==============================
   Multi-list setup
============================== */
let lists = {}; // { listName: [products] }
let currentList = null;

function ensureDefaultList() {
  const listNames = Object.keys(lists);

  if (listNames.length === 0) {
    lists['My List'] = [];
    currentList = 'My List';
    saveLists();
  } else if (!currentList || !lists[currentList]) {
    currentList = listNames[0];
    saveLists();
  }
}


window.onload = () => {
  const savedLists = localStorage.getItem('wishlistLists');
  const savedCurrent = localStorage.getItem('currentList');

  if (savedLists) {
    lists = JSON.parse(savedLists);
  }

  currentList = savedCurrent;

  ensureDefaultList();   // üëà guarantees a list exists

  renderListSidebar();
  renderWishlist();
  refreshMissingImages();
  normalizeAllSavedLinks();
};


function normalizeAllSavedLinks() {
  let changed = false;

  Object.values(lists).forEach(list => {
    list.forEach(item => {
      const fixed = normalizeLink(item.link);
      if (fixed !== item.link) {
        item.link = fixed;
        changed = true;
      }
    });
  });

  if (changed) saveLists();
}


/* ==============================
   List functions
============================== */
function createList(name) {
  if (!name) return;
  if (lists[name]) { alert("List name already exists."); return; }
  lists[name] = [];
  currentList = name;
  saveLists();
  renderListSidebar();
  renderWishlist();
}

function deleteList(name) {
  if (!lists[name]) return;
  if (!confirm(`Delete list "${name}"? This cannot be undone.`)) return;

  delete lists[name];
  ensureDefaultList();   // üëà auto-create default if last list was deleted
  saveLists();
  renderListSidebar();
  renderWishlist();
}


function renameList(oldName, newName) {
  if (!newName || lists[newName]) { alert("Invalid or duplicate list name."); return; }
  lists[newName] = lists[oldName];
  delete lists[oldName];
  if (currentList === oldName) currentList = newName;
  saveLists();
  renderListSidebar();
}

function saveLists() {
  localStorage.setItem('wishlistLists', JSON.stringify(lists));
  localStorage.setItem('currentList', currentList);
}

function renderListSidebar() {
  const container = document.getElementById('listContainer');
  container.innerHTML = '';

  for (const name of Object.keys(lists)) {
    const div = document.createElement('div');
    div.className = 'list-item' + (name === currentList ? ' active' : '');

    const label = document.createElement('span');
    label.textContent = name;
    label.style.flex = '1';

    div.onclick = () => {
      currentList = name;
      saveLists();
      renderListSidebar();
      renderWishlist();
    };

    const menu = document.createElement('span');
    menu.className = 'list-menu';
    menu.textContent = '‚ãÆ';

    menu.onclick = (e) => {
      e.stopPropagation();
      document.querySelectorAll('.list-tooltip').forEach(t => t.remove());

      const tooltip = document.createElement('div');
      tooltip.className = 'list-tooltip';
      tooltip.onclick = (e) => e.stopPropagation();

      const renameBtn = document.createElement('button');
      renameBtn.textContent = '‚úèÔ∏è Rename';
      renameBtn.onclick = () => {
        const newName = prompt("Enter new list name:", name);
        renameList(name, newName);
        tooltip.remove();
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'üóë Delete';
      deleteBtn.onclick = () => {
        deleteList(name);
        tooltip.remove();
      };

      tooltip.appendChild(renameBtn);
      tooltip.appendChild(deleteBtn);
      menu.appendChild(tooltip);

      setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
          tooltip.remove();
          document.removeEventListener('click', closeMenu);
        });
      }, 0);
    };

    div.appendChild(label);
    div.appendChild(menu);
    container.appendChild(div);
  }
}

document.getElementById('newListBtn').onclick = () => {
  const name = prompt("Enter new list name:");
  if (name) createList(name);
};

/* ==============================
   Wishlist logic
============================== */
function formatPrice(num) {
  return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function resolveAmazonImage(asin, callback) {
  if (!asin) return callback('');

  const candidates = [
    `https://m.media-amazon.com/images/I/${asin}._AC_UL320_.jpg`,
    `https://images-na.ssl-images-amazon.com/images/P/${asin}.01._AC_UL320_.jpg`,
    `https://images-na.ssl-images-amazon.com/images/P/${asin}._AC_UL320_.jpg`
  ];

  let index = 0;

  function tryNext() {
    if (index >= candidates.length) {
      callback('');
      return;
    }

    const img = new Image();
    img.onload = () => callback(candidates[index]);
    img.onerror = () => {
      index++;
      tryNext();
    };
    img.src = candidates[index];
  }

  tryNext();
}

function refreshMissingImages(delay = 400) {
  if (!currentList) return;

  const wishlist = lists[currentList];
  let index = 0;

  function processNext() {
    if (index >= wishlist.length) {
      saveLists();
      renderWishlist();
      return;
    }

    const product = wishlist[index++];
    if (product.imageUrl) {
      processNext();
      return;
    }

    const asinMatch =
      product.link.match(/\/dp\/([A-Z0-9]{10})/) ||
      product.link.match(/\/gp\/product\/([A-Z0-9]{10})/);

    if (!asinMatch) {
      processNext();
      return;
    }

    resolveAmazonImage(asinMatch[1], (imgUrl) => {
      if (imgUrl) product.imageUrl = imgUrl;
      setTimeout(processNext, delay);
    });
  }

  processNext();
}

function normalizeLink(link) {
  if (!link) return '';

  link = link.trim().replace(/^"+|"+$/g, '');

  // fix missing colon in https//
  if (/^https\/\//i.test(link)) {
    link = link.replace(/^https\/\//i, 'https://');
  }

  // add protocol if missing
  if (!/^https?:\/\//i.test(link)) {
    link = 'https://' + link;
  }

  return link;
}




function addProduct(product = null) {
  if (!currentList) return alert("No list selected.");
  let link, name, price, quantity;

  if (product) {
  link = normalizeLink(product.link);
  name = product.name;
  price = product.price;
  quantity = product.quantity || 1;
  }else {
  link = normalizeLink(document.getElementById('productLink').value);
    name = document.getElementById('productName').value.trim();
    price = parseFloat(document.getElementById('productPrice').value);
    quantity = parseInt(document.getElementById('productQuantity').value) || 1;
  }

  if (!link || !name || isNaN(price) || price < 0 || quantity < 1) {
    if (!product) alert("Please fill in all fields with valid values.");
    return;
  }

  name = name.replace(/,+$/,'');

  const wishlist = lists[currentList];
  const existing = wishlist.find(p => p.link === link);
  if (existing) {
    existing.quantity += quantity;
  } else {
    const asinMatch =
  link.match(/\/dp\/([A-Z0-9]{10})/) ||
  link.match(/\/gp\/product\/([A-Z0-9]{10})/);

const productObj = { link, name, price, quantity, imageUrl: '' };
wishlist.push(productObj);

if (asinMatch) {
  resolveAmazonImage(asinMatch[1], (imgUrl) => {
    productObj.imageUrl = imgUrl;
    saveLists();
    renderWishlist();
  });
}
;
  }

  saveLists();
  renderWishlist();

  if (!product) {
    document.getElementById('productLink').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productQuantity').value = 1;
  }
}

function renderWishlist() {
  const tbody = document.getElementById('wishlistBody');
  const previewContainer = document.getElementById('previews');
  tbody.innerHTML = '';
  previewContainer.innerHTML = '';
  if (!currentList) return;

  const wishlist = lists[currentList];
  let totalPrice = 0;
  let totalQty = 0;

  wishlist.forEach(product => {
    totalPrice += product.price * product.quantity;
    totalQty += product.quantity;

    const row = document.createElement('tr');
    row.dataset.link = product.link;

    const nameCell = document.createElement('td');
    nameCell.textContent = product.name;

    const linkCell = document.createElement('td');
    const a = document.createElement('a');
    a.href = product.link;
    a.textContent = "View Product";
    a.target = "_blank";
    linkCell.appendChild(a);

    const priceCell = document.createElement('td');
    priceCell.textContent = formatPrice(product.price);

    const qtyCell = document.createElement('td');
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = 1;
    qtyInput.value = product.quantity;
    qtyInput.className = 'qty-input';
    qtyInput.oninput = () => {
      const val = parseInt(qtyInput.value);
      product.quantity = isNaN(val) || val < 1 ? 1 : val;
      renderWishlist();
    };
    qtyCell.appendChild(qtyInput);

    const removeCell = document.createElement('td');
    const removeBtn = document.createElement('button');
    removeBtn.textContent = "Remove";
    removeBtn.className = "remove-btn";
    removeBtn.onclick = () => {
      lists[currentList] = wishlist.filter(p => p.link !== product.link);
      saveLists();
      renderWishlist();
    };
    removeCell.appendChild(removeBtn);

    row.appendChild(nameCell);
    row.appendChild(linkCell);
    row.appendChild(priceCell);
    row.appendChild(qtyCell);
    row.appendChild(removeCell);
    tbody.appendChild(row);

    const previewDiv = document.createElement('div');
    previewDiv.className = 'preview-card';
    previewDiv.dataset.link = product.link;

    const qtyDropdown = document.createElement('select');
    qtyDropdown.className = 'qty-dropdown';
    for (let i = 1; i <= 100; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      if (i === product.quantity) opt.selected = true;
      qtyDropdown.appendChild(opt);
    }
    qtyDropdown.onchange = () => {
      product.quantity = parseInt(qtyDropdown.value);
      renderWishlist();
    };

    previewDiv.innerHTML = `
      ${product.imageUrl ? `<img src="${product.imageUrl}" alt="${product.name}">` : ''}
      <div>
        <strong>${product.name}</strong>
        <span>$${formatPrice(product.price)}</span>
        <a href="${product.link}" target="_blank">View</a>
      </div>
    `;
    previewDiv.appendChild(qtyDropdown);
    previewContainer.appendChild(previewDiv);
  });

  document.getElementById('totalPrice').textContent = formatPrice(totalPrice);
  document.getElementById('totalQuantity').textContent = totalQty;
}

/* ==============================
   CSV Export
============================== */
document.getElementById('exportBtn').addEventListener('click', () => {
  if (!currentList || !lists[currentList].length) return alert("No items to export.");
  const products = lists[currentList];
  let csvContent = "data:text/csv;charset=utf-8,Name,Price,Link,Quantity\n";
  products.forEach(p => {
    csvContent += `"${p.name}","${p.price}","${p.link}","${p.quantity}"\n`;
  });
  const encoded = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encoded);
  link.setAttribute("download", `${currentList}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

/* ==============================
   CSV Import
============================== */
document.getElementById('csvFile').addEventListener('change', function () {
  if (!currentList) return alert("No list selected.");
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return;
    lines.shift(); // remove header
    lines.forEach(line => {
      const [name, price, link, quantity] = line.split(',');
      if (name && price && link) {
        addProduct({
          name: name.replace(/"/g,'').trim(),
          price: parseFloat(price),
          link: link.replace(/"/g,'').trim(),
          quantity: parseInt(quantity) || 1
        });
      }
    });
    this.value = '';
  };
  reader.readAsText(file);
});

/* ==============================
   Floating CSV menu
============================== */
const csvMenuBtn = document.getElementById('csvMenuBtn');
const csvMenuOptions = document.getElementById('csvMenuOptions');

csvMenuBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  csvMenuOptions.style.display =
    csvMenuOptions.style.display === 'block' ? 'none' : 'block';
});

csvMenuOptions.addEventListener('click', e => e.stopPropagation());

document.addEventListener('click', () => {
  csvMenuOptions.style.display = 'none';
});

document.getElementById('csvImportBtn').onclick = () => {
  document.getElementById('csvFile').click();
};

document.getElementById('csvExportBtn').onclick = () => {
  document.getElementById('exportBtn').click();
};

</script>
</body>
</html>
